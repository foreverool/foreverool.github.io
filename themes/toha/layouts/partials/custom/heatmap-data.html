<script src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var dataMap = {};
  {{ $postsPages := where (where .Site.Pages "Section" "posts") "Kind" "page" }}
  {{ $notesPages :=  where (where .Site.Pages "Section" "notes") "Kind" "page" }}
  {{ $allPages := $postsPages | union $notesPages}}
  {{ range $allPages }} // Works on regular content pages, i.e. not list pages, taxonomy, terms. 
    // 1. å®šä¹‰å½“å‰æ–‡ç« çš„è¯¦æƒ…å¯¹è±¡ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé¿å…ç ´å JS è¯­æ³•ï¼‰
  var articleDetail = {
    wordCount: {{ .WordCount }}, // æ–‡ç« å­—æ•°ï¼ˆæ•°å­—ç±»å‹ï¼Œç›´æ¥åµŒå…¥ï¼‰
    link: "{{ .RelPermalink | htmlEscape }}" // æ–‡ç« ç›¸å¯¹é“¾æ¥ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼‰
  };

  // 2. å®šä¹‰å½“å‰æ–‡ç« çš„æ˜ å°„å¯¹è±¡ï¼ˆé”®ï¼šè½¬ä¹‰åçš„æ–‡ç« æ ‡é¢˜ï¼Œå€¼ï¼šæ–‡ç« è¯¦æƒ…ï¼‰
  var articleMap = {};
  articleMap["{{ .Title | htmlEscape }}"] = articleDetail;

  // 3. å®šä¹‰å½“å‰æ—¥æœŸï¼ˆè½¬ä¹‰ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ï¼Œä½œä¸º dataMap çš„é”®ï¼‰
  var currentDate = "{{ .Date.Format "2006-01-02" | htmlEscape }}";

  // 4. å…³é”®ï¼šåˆ¤æ–­å½“å‰æ—¥æœŸå¯¹åº”çš„æ•°ç»„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆå§‹åŒ–ç©ºæ•°ç»„ï¼ˆé¿å…é‡ç½®ï¼‰
  if (!Array.isArray(dataMap[currentDate])) {
    dataMap[currentDate] = [];
  }

  // 5. è¡¥å…¨é€»è¾‘ï¼šå°†æ–‡ç« æ˜ å°„å¯¹è±¡æ¨å…¥å¯¹åº”æ—¥æœŸçš„æ•°ç»„ï¼ˆå®ç°æ•°æ®ç´¯åŠ ï¼‰
  dataMap[currentDate].push(articleMap);

  {{ end }}
 
  
  function filterDataByYear(year) {
    var filtered = [];
    for (const [date, value] of Object.entries(dataMap)) {
   
      if (date.startsWith(year)) {
        var count = 0
        for (let i = 0; i<value.length; i++){
          for (const [t, v] of Object.entries(value[i]))
        {
              
              count = count + v.wordCount
        }
        }
        console.log(count)
        filtered.push([date, count]);
      }
    }
 
    return filtered;
  }

  // Count the total number of posts per year
  function getDotCount(year) {
    let count = 0;
    for (const [date,value] of  Object.entries(dataMap)) {
        if (date.startsWith(year)) {
            count = count + value.length
        }
    }
    return count;
    }

  var chartDom = document.getElementById('heatmap');
 var myChart = echarts.init(chartDom, null, { renderer: 'canvas' }); // Renderer can = canvas or svg. Try both to see which works better for you

  // Resize event listener
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            myChart.resize();
        }, 100); // Wait 100ms after last resize event
    });

  function createOption(year) {
    const dotCount = getDotCount(year);
    return {
    textStyle: { // Global text styles
       fontFamily: 'monospace'
    },
    title: [ 
        {
        top: 8,
        show: true,
        text: year+ 'å¹´ä¸€å…±å‘å¸ƒäº† ' + dotCount + ' ç¯‡æ–‡ç« ğŸ˜‚' ,
        left: 'left',
        padding: [5, 20],
        textStyle: {
            color: '#f3939d',
            fontSize: 16,
            fontWeight: 600
        }
    },
    {
        text: '', // Enter your own message or remove this extra description section
        left: 'left',
        bottom: 'bottom',
        padding: [13, 22],
        textStyle: {
            color: '#A1A1A1',
            fontStyle: 'italic',
            fontSize: 10,
            fontWeight: 200
        }
    }
],
    tooltip: {
      formatter: function (p) {
        const post = dataMap[p.data[0]];
        const formattedDate = echarts.format.formatTime('MM/dd', p.data[0]);
        var count = 0 

        for (let i = 0 ; i< post.length; i++){
            for (const [t,v] of Object.entries(post[i])){
                count += v.wordCount
              }
        }
         return formattedDate + ' | ' + count + ' words' + '<br/> ' + 'å‘å¸ƒäº†' + post.length + 'ç¯‡æ–‡ç« ' + '<br/>';
        
      },
        show: true,
        confine: true,
        appendToBody: true,
        trigger: 'item',
        triggerOn: 'mousemove|click',
        textStyle: {
            color: "#DBDBDB",
            fontWeight: 400,
            fontSize: 13
        },
        backgroundColor: "#302010",
        borderWidth: '1',
        padding: [3, 6]
    },
    visualMap: {
        min: 0,
        max: 4000, // Adjust max word count to get the maximum gradient color variation, and according to your usual post length
        splitNumber: 4, // Each colour group is 1000 words apart (4000/4)
        type: 'piecewise',
        orient: 'horizontal',
        left: 'right',
        padding: [14, 20], 
        top: 'bottom',
        inRange: {   
          color: ['#00de00', '#005e00'] // Light to dark gradient
        },
        text: ['Long', 'Short'],
        textStyle: {
            color: '#A1A1A1',
            fontStyle: 'italic',
        },
        fontWeight: 400,
        showLabel: false,
         pieces: [
            { min: 0, max: 999, label: '0-1k' },
            { min: 1000, max: 1999, label: '1k-2k' },
            { min: 2000, max: 2999, label: '2k-3k' },
            { min: 3000, max: 99999, label: '3k+' },
        ],
        itemGap: 8,
    },
    calendar: {
        top: 70,
        left: 40,
        bottom: 45, 
        right: 10,
        cellSize: 'auto',
        orient: 'horizontal',
        range: year,
        itemStyle: {
          color: '#EAF3DE', // Base grid color
          borderWidth: 2,
          borderType: 'solid',
          borderColor: '#ffffff', // Grid lines
        },
        yearLabel: {
            show: false // Included year in title
        },
        splitLine: {  // Month-splitting lines
          show: true, // Set to false for a more GitHub look
          lineStyle: {
            color: "#A1A1A1",
            width: 0.3,
            type: 'solid',
            opacity: 0.8
            }
        },
        monthLabel: {
            show: true,
            formatter: '{nameMap}',
            fontSize: 12,
            color: '#A1A1A1',
            fontWeight: 400,
            silent: true
        },
        dayLabel: {
          show: true,
          firstDay: 1,  // Monday start, or 0 for Sunday
          color: '#A1A1A1',
          fontSize: 10,
          fontWeight: 200,
          silent: true
        }
    },
    series: {
        type: 'heatmap',
        coordinateSystem: 'calendar',
        data: filterDataByYear(year),
        label: {
            show: false,
        }
    }
    };
  }
    window.changeYear = function(year) {
        let option = createOption(year);
        myChart.setOption(option, true);
    }

    window.addEventListener('resize', () => myChart.resize()); // Resize listener
    myChart.on('click', function(params) {
      if (params.componentType === 'series') {
        const post = dataMap[params.data[0]][0];
        if (post) {
          for (const [t,v] of Object.entries(post)){
             const link = window.location.origin +v.link;
              window.open(link, '_blank').focus();
          }
         
        }
      }
    });

  // Initialize with the current year with Hugo's now.Format or manually `changeYear('2020')`
  changeYear('{{ now.Format "2006" }}');
  });

// // Uncomment line below to access the JSON dataMap in browser console with`JSON.stringify([window.__dataMapSnapshot])`. Only works when in localhost mode or when the word debug is in the URL like `?debug`
//   if (location.search.includes('debug') || location.hostname === 'localhost') {
//   window.__dataMapSnapshot = Object.freeze(Object.fromEntries(dataMap));
// }
</script>